<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NLE Project Tracking</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}:root{--bg:#f8fafc;--card:#fff;--hover:#f1f5f9;--blue:#2563eb;--green:#059669;--yellow:#d97706;--red:#dc2626;--purple:#7c3aed;--text:#1e293b;--muted:#64748b;--light:#94a3b8;--border:#e2e8f0}body{font-family:Inter,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#1e3a5f,#2563eb)}.login-card{background:#fff;padding:48px;border-radius:16px;text-align:center;max-width:400px;width:90%}.login-logo{font-size:48px;margin-bottom:16px}.login-title{font-size:24px;font-weight:700;margin-bottom:8px}.login-subtitle{color:var(--muted);margin-bottom:32px}.login-btn{background:var(--blue);color:#fff;border:none;padding:14px 32px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:10px}.login-btn:hover{background:#1d4ed8}.login-error{color:var(--red);margin-top:16px}
    .app{display:none;min-height:100vh}.app.active{display:flex}.sidebar{width:250px;background:var(--card);border-right:1px solid var(--border);padding:20px 12px;position:fixed;height:100vh;overflow-y:auto}.logo{display:flex;align-items:center;gap:10px;padding:8px 12px;margin-bottom:24px}.logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--blue),var(--purple));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff}.logo-text{font-size:18px;font-weight:700}.logo-text span{color:var(--blue)}.nav-title{font-size:11px;font-weight:600;text-transform:uppercase;color:var(--light);padding:8px 12px}.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;color:var(--muted);font-weight:500;font-size:14px}.nav-item:hover{background:var(--hover);color:var(--text)}.nav-item.active{background:#eff6ff;color:var(--blue);font-weight:600}.nav-badge{margin-left:auto;background:var(--blue);color:#fff;font-size:11px;font-weight:600;padding:2px 8px;border-radius:10px}.user-info{padding:12px;border-top:1px solid var(--border);margin-top:20px}.user-name{font-size:13px;font-weight:600}.user-email{font-size:11px;color:var(--muted)}.logout-btn{margin-top:8px;font-size:12px;color:var(--red);cursor:pointer}
    .main{flex:1;margin-left:250px;padding:24px}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}.header h1{font-size:24px;font-weight:700;margin-bottom:4px}.header p{color:var(--muted);font-size:14px}.header-actions{display:flex;gap:10px}.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;border:none;font-family:inherit}.btn-primary{background:var(--blue);color:#fff}.btn-primary:hover{background:#1d4ed8}.btn-secondary{background:#fff;color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{background:var(--hover)}
    .page{display:none}.page.active{display:block}.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}.stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px}.stat-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;font-size:18px}.stat-icon.blue{background:#dbeafe}.stat-icon.green{background:#d1fae5}.stat-icon.yellow{background:#fef3c7}.stat-icon.purple{background:#ede9fe}.stat-label{font-size:13px;color:var(--muted);margin-bottom:4px}.stat-value{font-size:28px;font-weight:700}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}.card-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border);background:var(--bg)}.card-title{font-size:15px;font-weight:600}.search{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--border);border-radius:8px;padding:8px 12px;width:220px}.search input{background:none;border:none;color:var(--text);font-size:14px;width:100%;outline:none}
    table{width:100%;border-collapse:collapse}th{text-align:left;padding:12px 20px;font-size:12px;font-weight:600;text-transform:uppercase;color:var(--light);background:var(--bg);border-bottom:1px solid var(--border)}td{padding:14px 20px;font-size:14px;border-bottom:1px solid var(--border)}tr:hover td{background:#f8fafc}tr{cursor:pointer}.est-name{font-weight:600}.est-loc{font-size:12px;color:var(--muted);margin-top:2px}.cust-cell{display:flex;align-items:center;gap:10px}.avatar{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--blue),var(--purple));display:flex;align-items:center;justify-content:center;font-weight:600;font-size:12px;color:#fff}.status{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600}.status.draft{background:#f1f5f9;color:#64748b}.status.submitted{background:#dbeafe;color:#1d4ed8}.status.won{background:#d1fae5;color:#047857}.status.lost{background:#fee2e2;color:#b91c1c}.status-dot{width:6px;height:6px;border-radius:50%;background:currentColor}.amount{font-weight:600}.action-btn{width:32px;height:32px;border-radius:6px;background:#fff;border:1px solid var(--border);color:var(--muted);cursor:pointer;display:inline-flex;align-items:center;justify-content:center}.action-btn:hover{background:var(--blue);border-color:var(--blue);color:#fff}
    .form-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:28px;max-width:700px}.form-title{font-size:18px;font-weight:700;margin-bottom:4px}.form-subtitle{color:var(--muted);font-size:14px;margin-bottom:24px}.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}.form-group{margin-bottom:16px}.form-group.full{grid-column:1/-1}.form-label{display:block;font-size:13px;font-weight:600;color:var(--muted);margin-bottom:6px}.required{color:var(--red)}.form-input,.form-select,.form-textarea{width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;font-family:inherit}.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--blue)}.form-textarea{min-height:80px;resize:vertical}.form-actions{display:flex;gap:10px;margin-top:24px;padding-top:20px;border-top:1px solid var(--border)}.back-link{display:inline-flex;align-items:center;gap:6px;color:var(--muted);font-size:14px;font-weight:500;cursor:pointer;margin-bottom:16px}.back-link:hover{color:var(--blue)}
    .detail-title{font-size:22px;font-weight:700;margin-bottom:8px}.detail-meta{display:flex;gap:20px;color:var(--muted);font-size:13px}.detail-grid{display:grid;grid-template-columns:2fr 1fr;gap:20px}.detail-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px}.detail-card h3{font-size:15px;font-weight:600;margin-bottom:16px;display:flex;justify-content:space-between}.summary-card{background:linear-gradient(135deg,#eff6ff,#f5f3ff);border-color:#c7d2fe}.summary-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}.summary-row:last-child{border:none}.summary-row.total{font-size:18px;font-weight:700;padding-top:14px;margin-top:8px;border-top:2px solid var(--blue)}.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}.info-item{padding:12px;background:var(--bg);border-radius:8px}.info-label{font-size:11px;font-weight:600;text-transform:uppercase;color:var(--light);margin-bottom:4px}.info-value{font-size:14px;font-weight:500}
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center}.modal-overlay.active{display:flex}.modal{background:#fff;border-radius:12px;padding:24px;width:100%;max-width:450px}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.modal-title{font-size:16px;font-weight:700}.modal-close{width:28px;height:28px;border-radius:6px;background:var(--bg);border:1px solid var(--border);color:var(--muted);cursor:pointer}.modal-close:hover{background:#fee2e2;color:var(--red)}
    .toast{position:fixed;bottom:20px;right:20px;background:#fff;border:1px solid var(--green);border-radius:10px;padding:14px 20px;display:flex;align-items:center;gap:10px;z-index:2000;transform:translateY(100px);opacity:0;transition:all 0.3s}.toast.active{transform:translateY(0);opacity:1}.toast-icon{color:var(--green);font-size:18px}
    .loading{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--muted)}.spinner{width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin 1s linear infinite;margin-right:12px}@keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:1200px){.stats{grid-template-columns:repeat(2,1fr)}.detail-grid{grid-template-columns:1fr}}@media(max-width:768px){.sidebar{display:none}.main{margin-left:0}.form-grid{grid-template-columns:1fr}.stats{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="loginScreen" class="login-screen"><div class="login-card"><div class="login-logo">‚ö°</div><div class="login-title">NLE Project Tracking</div><div class="login-subtitle">Sign in with your Microsoft account</div><button class="login-btn" onclick="signIn()"><svg width="20" height="20" viewBox="0 0 21 21"><rect x="1" y="1" width="9" height="9" fill="#F25022"/><rect x="11" y="1" width="9" height="9" fill="#7FBA00"/><rect x="1" y="11" width="9" height="9" fill="#00A4EF"/><rect x="11" y="11" width="9" height="9" fill="#FFB900"/></svg>Sign in with Microsoft</button><div id="loginError" class="login-error"></div></div></div>
  <div id="app" class="app">
    <aside class="sidebar"><div class="logo"><div class="logo-icon">‚ö°</div><div class="logo-text">Next<span>Level</span></div></div><div class="nav-section"><div class="nav-title">Main</div><div class="nav-item active" data-page="dashboard">üìä Dashboard</div><div class="nav-item" data-page="estimates">üìã Estimates <span class="nav-badge" id="estCount">0</span></div><div class="nav-item" data-page="customers">üë• Customers</div></div><div class="nav-section"><div class="nav-title">Settings</div><div class="nav-item" data-page="phases">üì¶ Phases</div></div><div class="user-info"><div class="user-name" id="userName">Loading...</div><div class="user-email" id="userEmail"></div><div class="logout-btn" onclick="signOut()">Sign out</div></div></aside>
    <main class="main">
      <div id="page-dashboard" class="page active"><div class="header"><div><h1>Dashboard</h1><p>Welcome back! Here's your estimate pipeline.</p></div><div class="header-actions"><button class="btn btn-secondary" onclick="exportAll()">üì§ Export</button><button class="btn btn-primary" onclick="goTo('new-estimate')">+ New Estimate</button></div></div><div class="stats"><div class="stat"><div class="stat-icon blue">üìä</div><div class="stat-label">Total Pipeline</div><div class="stat-value" id="s-pipeline">$0</div></div><div class="stat"><div class="stat-icon green">‚úì</div><div class="stat-label">Won</div><div class="stat-value" id="s-won">$0</div></div><div class="stat"><div class="stat-icon yellow">‚è≥</div><div class="stat-label">Pending</div><div class="stat-value" id="s-pending">$0</div></div><div class="stat"><div class="stat-icon purple">üìà</div><div class="stat-label">Win Rate</div><div class="stat-value" id="s-rate">0%</div></div></div><div class="card"><div class="card-header"><div class="card-title">Recent Estimates</div><div class="search"><span>üîç</span><input type="text" placeholder="Search..." id="dashSearch" oninput="renderDashboard()"></div></div><table><thead><tr><th>Estimate</th><th>Customer</th><th>Status</th><th>Amount</th><th>Due</th><th></th></tr></thead><tbody id="dashTable"><tr><td colspan="6" class="loading"><div class="spinner"></div>Loading...</td></tr></tbody></table></div></div>
      <div id="page-estimates" class="page"><div class="header"><div><h1>Estimates</h1><p>Manage all your estimates</p></div><div class="header-actions"><button class="btn btn-secondary" onclick="exportAll()">üì§ Export</button><button class="btn btn-primary" onclick="goTo('new-estimate')">+ New Estimate</button></div></div><div class="card"><div class="card-header"><div class="card-title">All Estimates</div><div style="display:flex;gap:10px"><select class="form-select" style="width:140px;padding:8px" id="statusFilter" onchange="renderEstimates()"><option value="">All Status</option><option value="Draft">Draft</option><option value="Submitted">Submitted</option><option value="Won">Won</option><option value="Lost">Lost</option></select><div class="search"><span>üîç</span><input type="text" placeholder="Search..." id="estSearch" oninput="renderEstimates()"></div></div></div><table><thead><tr><th>Estimate</th><th>Customer</th><th>Status</th><th>Amount</th><th>Due</th><th></th></tr></thead><tbody id="estTable"></tbody></table></div></div>
      <div id="page-new-estimate" class="page"><div class="back-link" onclick="goTo('estimates')">‚Üê Back to Estimates</div><div class="form-card"><div class="form-title">Create New Estimate</div><div class="form-subtitle">Enter estimate details</div><div class="form-grid"><div class="form-group"><label class="form-label">Estimate Name <span class="required">*</span></label><input type="text" class="form-input" id="f-name" placeholder="e.g., QuikTrip #1234"></div><div class="form-group"><label class="form-label">Customer <span class="required">*</span></label><select class="form-select" id="f-customer"></select></div><div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" id="f-location" placeholder="Address"></div><div class="form-group"><label class="form-label">Bid Due Date</label><input type="date" class="form-input" id="f-due"></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f-status"><option value="Draft">Draft</option><option value="Submitted">Submitted</option><option value="Won">Won</option><option value="Lost">Lost</option></select></div><div class="form-group"><label class="form-label">QB Estimate #</label><input type="text" class="form-input" id="f-qb"></div><div class="form-group full"><label class="form-label">Memo</label><textarea class="form-textarea" id="f-memo"></textarea></div><div class="form-group full"><label class="form-label">Exclusions</label><textarea class="form-textarea" id="f-excl"></textarea></div></div><div class="form-actions"><button class="btn btn-secondary" onclick="goTo('estimates')">Cancel</button><button class="btn btn-primary" onclick="createEstimate()">Create Estimate</button></div></div></div>
      <div id="page-detail" class="page"><div class="back-link" onclick="goTo('estimates')">‚Üê Back to Estimates</div><div class="header"><div><div class="detail-title" id="d-title">Estimate</div><div class="detail-meta"><span>üìç <span id="d-loc">-</span></span><span>üìÖ Due: <span id="d-due">-</span></span><span id="d-status"></span></div></div><div class="header-actions"><button class="btn btn-secondary" onclick="openEditModal()">‚úèÔ∏è Edit</button><button class="btn btn-secondary" onclick="exportEstimate()">üì§ Export</button><button class="btn btn-primary" onclick="openLineModal()">+ Add Line</button></div></div><div class="detail-grid"><div class="detail-card"><h3>Line Items <span style="font-weight:400;color:var(--muted);font-size:13px" id="d-count">0 items</span></h3><table><thead><tr><th>Item</th><th>Description</th><th style="text-align:right">Qty</th><th style="text-align:right">Rate</th><th style="text-align:right">Amount</th><th></th></tr></thead><tbody id="lineTable"></tbody></table></div><div><div class="detail-card summary-card" style="margin-bottom:16px"><h3>Summary</h3><div class="summary-row"><span>Subtotal</span><span class="amount" id="d-sub">$0</span></div><div class="summary-row total"><span>Total</span><span class="amount" id="d-total">$0</span></div></div><div class="detail-card"><h3>Details</h3><div class="info-grid"><div class="info-item"><div class="info-label">Customer</div><div class="info-value" id="d-cust">-</div></div><div class="info-item"><div class="info-label">QB #</div><div class="info-value" id="d-qb">-</div></div></div><div class="info-item" style="margin-top:12px"><div class="info-label">Memo</div><div class="info-value" id="d-memo">-</div></div><div class="info-item" style="margin-top:12px"><div class="info-label">Exclusions</div><div class="info-value" id="d-excl">-</div></div></div></div></div></div>
      <div id="page-customers" class="page"><div class="header"><div><h1>Customers</h1><p>Manage your customers</p></div><div class="header-actions"><button class="btn btn-primary" onclick="openCustModal()">+ Add Customer</button></div></div><div class="card"><table><thead><tr><th>Customer</th><th>Type</th><th>Phone</th><th>Email</th></tr></thead><tbody id="custTable"></tbody></table></div></div>
      <div id="page-phases" class="page"><div class="header"><div><h1>Phases</h1><p>Construction phases</p></div></div><div class="card"><table><thead><tr><th>Phase</th><th>Order</th><th>Description</th></tr></thead><tbody id="phaseTable"></tbody></table></div></div>
    </main>
  </div>
  <div class="modal-overlay" id="lineModal"><div class="modal"><div class="modal-header"><div class="modal-title">Add Line Item</div><button class="modal-close" onclick="closeLineModal()">‚úï</button></div><div class="form-group"><label class="form-label">Phase</label><select class="form-select" id="l-phase"></select></div><div class="form-group"><label class="form-label">Item Name <span class="required">*</span></label><input type="text" class="form-input" id="l-name"></div><div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="l-desc"></textarea></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px"><div class="form-group"><label class="form-label">Qty</label><input type="number" class="form-input" id="l-qty" value="1" oninput="calcAmt()"></div><div class="form-group"><label class="form-label">Rate</label><input type="number" class="form-input" id="l-rate" step="0.01" oninput="calcAmt()"></div><div class="form-group"><label class="form-label">Amount <span class="required">*</span></label><input type="number" class="form-input" id="l-amt" step="0.01"></div></div><div class="form-actions"><button class="btn btn-secondary" onclick="closeLineModal()">Cancel</button><button class="btn btn-primary" onclick="addLine()">Add</button></div></div></div>
  <div class="modal-overlay" id="custModal"><div class="modal"><div class="modal-header"><div class="modal-title">Add Customer</div><button class="modal-close" onclick="closeCustModal()">‚úï</button></div><div class="form-group"><label class="form-label">Name <span class="required">*</span></label><input type="text" class="form-input" id="c-name"></div><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="c-type"><option value="GC">GC</option><option value="Owner">Owner</option><option value="Developer">Developer</option><option value="Other">Other</option></select></div><div class="form-group"><label class="form-label">Phone</label><input type="text" class="form-input" id="c-phone"></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="c-email"></div><div class="form-actions"><button class="btn btn-secondary" onclick="closeCustModal()">Cancel</button><button class="btn btn-primary" onclick="addCustomer()">Add</button></div></div></div>
  <div class="modal-overlay" id="editModal"><div class="modal" style="max-width:550px"><div class="modal-header"><div class="modal-title">Edit Estimate</div><button class="modal-close" onclick="closeEditModal()">‚úï</button></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div class="form-group"><label class="form-label">Name <span class="required">*</span></label><input type="text" class="form-input" id="e-name"></div><div class="form-group"><label class="form-label">Customer</label><select class="form-select" id="e-customer"></select></div><div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" id="e-location"></div><div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="e-due"></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="e-status"><option value="Draft">Draft</option><option value="Submitted">Submitted</option><option value="Won">Won</option><option value="Lost">Lost</option></select></div><div class="form-group"><label class="form-label">QB #</label><input type="text" class="form-input" id="e-qb"></div><div class="form-group" style="grid-column:1/-1"><label class="form-label">Memo</label><textarea class="form-textarea" id="e-memo"></textarea></div><div class="form-group" style="grid-column:1/-1"><label class="form-label">Exclusions</label><textarea class="form-textarea" id="e-excl"></textarea></div></div><div class="form-actions"><button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button><button class="btn btn-primary" onclick="saveEstimate()">Save</button></div></div></div>
  <div class="toast" id="toast"><span class="toast-icon">‚úì</span><span id="toastMsg">Success!</span></div>
<script>
const msalConfig={auth:{clientId:'c028eb75-5f9d-41fe-bb27-d346eff5e199',authority:'https://login.microsoftonline.com/2b806475-77ad-4362-b1c0-52db81987a46',redirectUri:window.location.origin},cache:{cacheLocation:'localStorage'}};
const dataverseUrl='https://org12179381.crm.dynamics.com';
const msal_=new msal.PublicClientApplication(msalConfig);
let phases=[],customers=[],estimates=[],lines=[],currentEst=null,token=null;

async function signIn(){try{const r=await msal_.loginPopup({scopes:[dataverseUrl+'/.default']});await handleLogin(r.account)}catch(e){document.getElementById('loginError').textContent='Login failed: '+e.message}}
async function handleLogin(a){if(!a)return;document.getElementById('userName').textContent=a.name||'User';document.getElementById('userEmail').textContent=a.username||'';try{const t=await msal_.acquireTokenSilent({scopes:[dataverseUrl+'/.default'],account:a});token=t.accessToken;document.getElementById('loginScreen').style.display='none';document.getElementById('app').classList.add('active');await loadAll()}catch(e){if(e instanceof msal.InteractionRequiredAuthError){const t=await msal_.acquireTokenPopup({scopes:[dataverseUrl+'/.default']});token=t.accessToken;document.getElementById('loginScreen').style.display='none';document.getElementById('app').classList.add('active');await loadAll()}}}
function signOut(){msal_.logoutPopup();document.getElementById('app').classList.remove('active');document.getElementById('loginScreen').style.display='flex'}
msal_.initialize().then(()=>{const a=msal_.getAllAccounts();if(a.length>0)handleLogin(a[0])});

async function api(e,s,f){let u=dataverseUrl+'/api/data/v9.2/'+e;let p=[];if(s)p.push('$select='+s);if(f)p.push('$filter='+f);if(p.length)u+='?'+p.join('&');const r=await fetch(u,{headers:{Authorization:'Bearer '+token,Accept:'application/json','OData-MaxVersion':'4.0','OData-Version':'4.0'}});if(!r.ok){const t=await r.text();throw new Error(t)}const d=await r.json();return d.value||[]}
async function apiPost(e,d){const r=await fetch(dataverseUrl+'/api/data/v9.2/'+e,{method:'POST',headers:{Authorization:'Bearer '+token,Accept:'application/json','Content-Type':'application/json','OData-MaxVersion':'4.0','OData-Version':'4.0'},body:JSON.stringify(d)});if(!r.ok){const t=await r.text();throw new Error(t)}const l=r.headers.get('OData-EntityId');return l?l.match(/\(([^)]+)\)/)?.[1]:null}
async function apiPatch(e,id,d){const r=await fetch(dataverseUrl+'/api/data/v9.2/'+e+'('+id+')',{method:'PATCH',headers:{Authorization:'Bearer '+token,Accept:'application/json','Content-Type':'application/json','OData-MaxVersion':'4.0','OData-Version':'4.0'},body:JSON.stringify(d)});return r.ok}
async function apiDel(e,id){const r=await fetch(dataverseUrl+'/api/data/v9.2/'+e+'('+id+')',{method:'DELETE',headers:{Authorization:'Bearer '+token,'OData-MaxVersion':'4.0','OData-Version':'4.0'}});return r.ok}

async function loadAll(){try{await Promise.all([loadPhases(),loadCustomers(),loadEstimates()]);renderDashboard()}catch(e){console.error(e);toast('Error loading data')}}
async function loadPhases(){const d=await api('cr673_nle2_phases','cr673_nle2_phaseid,cr673_Phase1,cr673_SortOrder,cr673_Description');phases=d.map(p=>({id:p.cr673_nle2_phaseid,name:p.cr673_Phase1||'',order:p.cr673_SortOrder||0,desc:p.cr673_Description||''}))}
async function loadCustomers(){const d=await api('cr673_nle2_customers','cr673_nle2_customerid,cr673_Customer1,cr673_CustomerType,cr673_Phone,cr673_Email');customers=d.map(c=>({id:c.cr673_nle2_customerid,name:c.cr673_Customer1||'',type:c.cr673_CustomerType||'Other',phone:c.cr673_Phone||'',email:c.cr673_Email||''}))}
async function loadEstimates(){const d=await api('cr673_nle2_estimates','cr673_nle2_estimateid,cr673_EstimateName,cr673_BidDueDate,cr673_Status,cr673_QBEstimateNo,cr673_Memo,cr673_Exclusions,cr673_ProjectLocation,cr673_TotalAmount,_cr673_Customer_value');estimates=d.map(e=>({id:e.cr673_nle2_estimateid,name:e.cr673_EstimateName||'',due:e.cr673_BidDueDate||'',status:e.cr673_Status||'Draft',qb:e.cr673_QBEstimateNo||'',memo:e.cr673_Memo||'',excl:e.cr673_Exclusions||'',loc:e.cr673_ProjectLocation||'',total:e.cr673_TotalAmount||0,custId:e._cr673_Customer_value||null}));document.getElementById('estCount').textContent=estimates.length}
async function loadLines(id){const d=await api('cr673_nle2_estimatelineitems','cr673_nle2_estimatelineitemid,cr673_EstimateLineItem1,cr673_Description,cr673_Quantity,cr673_Rate,cr673_Amount,_cr673_Phase_value','_cr673_Estimate_value eq '+id);lines=d.map(l=>({id:l.cr673_nle2_estimatelineitemid,phaseId:l._cr673_Phase_value,name:l.cr673_EstimateLineItem1||'',desc:l.cr673_Description||'',qty:l.cr673_Quantity||1,rate:l.cr673_Rate||0,amt:l.cr673_Amount||0}))}

document.querySelectorAll('.nav-item[data-page]').forEach(el=>el.addEventListener('click',()=>goTo(el.dataset.page)));
function goTo(p){document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));document.getElementById('page-'+p)?.classList.add('active');document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));document.querySelector('.nav-item[data-page="'+p+'"]')?.classList.add('active');if(p==='dashboard')renderDashboard();if(p==='estimates')renderEstimates();if(p==='customers')renderCustomers();if(p==='phases')renderPhases();if(p==='new-estimate')populateCustSel()}

function renderDashboard(){const s=document.getElementById('dashSearch')?.value.toLowerCase()||'';const pipe=estimates.filter(e=>e.status!=='Lost').reduce((a,e)=>a+(e.total||0),0);const won=estimates.filter(e=>e.status==='Won').reduce((a,e)=>a+(e.total||0),0);const pend=estimates.filter(e=>e.status==='Draft'||e.status==='Submitted').reduce((a,e)=>a+(e.total||0),0);const rate=estimates.length?Math.round(estimates.filter(e=>e.status==='Won').length/estimates.length*100):0;document.getElementById('s-pipeline').textContent=fmt(pipe);document.getElementById('s-won').textContent=fmt(won);document.getElementById('s-pending').textContent=fmt(pend);document.getElementById('s-rate').textContent=rate+'%';const f=estimates.filter(e=>e.name.toLowerCase().includes(s)||(e.loc||'').toLowerCase().includes(s)).slice(0,5);document.getElementById('dashTable').innerHTML=estRows(f)}
function renderEstimates(){const s=document.getElementById('estSearch')?.value.toLowerCase()||'';const st=document.getElementById('statusFilter')?.value||'';const f=estimates.filter(e=>(e.name.toLowerCase().includes(s)||(e.loc||'').toLowerCase().includes(s))&&(!st||e.status===st));document.getElementById('estTable').innerHTML=estRows(f)}
function estRows(es){if(!es.length)return '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:30px">No estimates</td></tr>';return es.map(e=>{const c=customers.find(x=>x.id===e.custId)||{name:'Unknown'};const i=(c.name||'U').split(' ').map(w=>w[0]).join('').slice(0,2);return '<tr onclick="viewEst(\''+e.id+'\')"><td><div class="est-name">'+e.name+'</div><div class="est-loc">'+(e.loc||'-')+'</div></td><td><div class="cust-cell"><div class="avatar">'+i+'</div>'+c.name+'</div></td><td><span class="status '+(e.status||'draft').toLowerCase()+'"><span class="status-dot"></span>'+(e.status||'Draft')+'</span></td><td class="amount">'+fmt(e.total||0)+'</td><td>'+(e.due?fmtD(e.due):'-')+'</td><td onclick="event.stopPropagation()"><button class="action-btn" onclick="viewEst(\''+e.id+'\')">üëÅ</button></td></tr>'}).join('')}
function renderCustomers(){document.getElementById('custTable').innerHTML=customers.length?customers.map(c=>{const i=(c.name||'U').split(' ').map(w=>w[0]).join('').slice(0,2);return '<tr><td><div class="cust-cell"><div class="avatar">'+i+'</div>'+c.name+'</div></td><td><span class="status '+(c.type==='GC'?'submitted':'draft')+'">'+(c.type||'Other')+'</span></td><td>'+(c.phone||'-')+'</td><td>'+(c.email||'-')+'</td></tr>'}).join(''):'<tr><td colspan="4" style="text-align:center;padding:30px">No customers</td></tr>'}
function renderPhases(){document.getElementById('phaseTable').innerHTML=phases.length?phases.sort((a,b)=>a.order-b.order).map(p=>'<tr><td><strong>'+p.name+'</strong></td><td>'+p.order+'</td><td>'+(p.desc||'-')+'</td></tr>').join(''):'<tr><td colspan="3" style="text-align:center;padding:30px">No phases</td></tr>'}

async function viewEst(id){currentEst=id;const e=estimates.find(x=>x.id===id);if(!e)return;const c=customers.find(x=>x.id===e.custId)||{name:'-'};document.getElementById('d-title').textContent=e.name;document.getElementById('d-loc').textContent=e.loc||'-';document.getElementById('d-due').textContent=e.due?fmtD(e.due):'-';document.getElementById('d-status').innerHTML='<span class="status '+(e.status||'draft').toLowerCase()+'"><span class="status-dot"></span>'+(e.status||'Draft')+'</span>';document.getElementById('d-cust').textContent=c.name;document.getElementById('d-qb').textContent=e.qb||'-';document.getElementById('d-memo').textContent=e.memo||'-';document.getElementById('d-excl').textContent=e.excl||'-';document.getElementById('lineTable').innerHTML='<tr><td colspan="6" class="loading"><div class="spinner"></div>Loading...</td></tr>';goTo('detail');await loadLines(id);document.getElementById('d-count').textContent=lines.length+' items';const t=lines.reduce((a,l)=>a+(l.amt||0),0);document.getElementById('d-sub').textContent=fmt(t);document.getElementById('d-total').textContent=fmt(t);document.getElementById('lineTable').innerHTML=lines.length?lines.map(l=>'<tr><td><strong>‚ö° '+l.name+'</strong></td><td style="color:var(--muted)">'+(l.desc||'-')+'</td><td style="text-align:right">'+l.qty+'</td><td style="text-align:right">'+(l.rate?fmt(l.rate):'-')+'</td><td style="text-align:right" class="amount">'+fmt(l.amt)+'</td><td><button class="action-btn" onclick="delLine(\''+l.id+'\')">üóë</button></td></tr>').join(''):'<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:30px">No line items</td></tr>';populatePhaseSel()}

function populateCustSel(){document.getElementById('f-customer').innerHTML='<option value="">Select...</option>'+customers.map(c=>'<option value="'+c.id+'">'+c.name+'</option>').join('')}
async function createEstimate(){const n=document.getElementById('f-name').value;const c=document.getElementById('f-customer').value;if(!n){alert('Enter name');return}if(!c){alert('Select customer');return}try{const id=await apiPost('cr673_nle2_estimates',{cr673_EstimateName:n,'cr673_Customer@odata.bind':'/cr673_nle2_customers('+c+')',cr673_ProjectLocation:document.getElementById('f-location').value||null,cr673_BidDueDate:document.getElementById('f-due').value||null,cr673_Status:document.getElementById('f-status').value||'Draft',cr673_QBEstimateNo:document.getElementById('f-qb').value||null,cr673_Memo:document.getElementById('f-memo').value||null,cr673_Exclusions:document.getElementById('f-excl').value||null,cr673_TotalAmount:0});await loadEstimates();toast('Created!');if(id)viewEst(id);else goTo('estimates')}catch(e){alert('Error: '+e.message)}}

function populatePhaseSel(){document.getElementById('l-phase').innerHTML='<option value="">Select...</option>'+phases.sort((a,b)=>a.order-b.order).map(p=>'<option value="'+p.id+'">'+p.name+'</option>').join('')}
function openLineModal(){document.getElementById('lineModal').classList.add('active');document.getElementById('l-name').value='';document.getElementById('l-desc').value='';document.getElementById('l-qty').value='1';document.getElementById('l-rate').value='';document.getElementById('l-amt').value=''}
function closeLineModal(){document.getElementById('lineModal').classList.remove('active')}
function calcAmt(){const q=parseFloat(document.getElementById('l-qty').value)||0;const r=parseFloat(document.getElementById('l-rate').value)||0;if(q>0&&r>0)document.getElementById('l-amt').value=(q*r).toFixed(2)}
async function addLine(){const n=document.getElementById('l-name').value;const a=document.getElementById('l-amt').value;if(!n){alert('Enter name');return}if(!a){alert('Enter amount');return}const p=document.getElementById('l-phase').value;const d={cr673_EstimateLineItem1:n,'cr673_Estimate@odata.bind':'/cr673_nle2_estimates('+currentEst+')',cr673_Description:document.getElementById('l-desc').value||null,cr673_Quantity:parseFloat(document.getElementById('l-qty').value)||1,cr673_Rate:parseFloat(document.getElementById('l-rate').value)||0,cr673_Amount:parseFloat(a)};if(p)d['cr673_Phase@odata.bind']='/cr673_nle2_phases('+p+')';try{await apiPost('cr673_nle2_estimatelineitems',d);await updTotal();closeLineModal();toast('Added!');viewEst(currentEst)}catch(e){alert('Error: '+e.message)}}
async function delLine(id){if(!confirm('Delete?'))return;try{await apiDel('cr673_nle2_estimatelineitems',id);await updTotal();toast('Deleted');viewEst(currentEst)}catch(e){alert('Error: '+e.message)}}
async function updTotal(){await loadLines(currentEst);const t=lines.reduce((a,l)=>a+(l.amt||0),0);await apiPatch('cr673_nle2_estimates',currentEst,{cr673_TotalAmount:t});await loadEstimates()}

function openEditModal(){const e=estimates.find(x=>x.id===currentEst);if(!e)return;document.getElementById('e-customer').innerHTML='<option value="">Select...</option>'+customers.map(c=>'<option value="'+c.id+'">'+c.name+'</option>').join('');document.getElementById('e-name').value=e.name;document.getElementById('e-customer').value=e.custId||'';document.getElementById('e-location').value=e.loc||'';document.getElementById('e-due').value=e.due||'';document.getElementById('e-status').value=e.status||'Draft';document.getElementById('e-qb').value=e.qb||'';document.getElementById('e-memo').value=e.memo||'';document.getElementById('e-excl').value=e.excl||'';document.getElementById('editModal').classList.add('active')}
function closeEditModal(){document.getElementById('editModal').classList.remove('active')}
async function saveEstimate(){const n=document.getElementById('e-name').value;if(!n){alert('Enter name');return}const c=document.getElementById('e-customer').value;const d={cr673_EstimateName:n,cr673_ProjectLocation:document.getElementById('e-location').value||null,cr673_BidDueDate:document.getElementById('e-due').value||null,cr673_Status:document.getElementById('e-status').value||'Draft',cr673_QBEstimateNo:document.getElementById('e-qb').value||null,cr673_Memo:document.getElementById('e-memo').value||null,cr673_Exclusions:document.getElementById('e-excl').value||null};if(c)d['cr673_Customer@odata.bind']='/cr673_nle2_customers('+c+')';try{await apiPatch('cr673_nle2_estimates',currentEst,d);await loadEstimates();closeEditModal();toast('Saved!');viewEst(currentEst)}catch(e){alert('Error: '+e.message)}}

function openCustModal(){document.getElementById('custModal').classList.add('active');document.getElementById('c-name').value='';document.getElementById('c-type').value='GC';document.getElementById('c-phone').value='';document.getElementById('c-email').value=''}
function closeCustModal(){document.getElementById('custModal').classList.remove('active')}
async function addCustomer(){const n=document.getElementById('c-name').value;if(!n){alert('Enter name');return}try{await apiPost('cr673_nle2_customers',{cr673_Customer1:n,cr673_CustomerType:document.getElementById('c-type').value||'Other',cr673_Phone:document.getElementById('c-phone').value||null,cr673_Email:document.getElementById('c-email').value||null});await loadCustomers();closeCustModal();toast('Added!');renderCustomers()}catch(e){alert('Error: '+e.message)}}

function exportEstimate(){const e=estimates.find(x=>x.id===currentEst);if(!e)return;const c=customers.find(x=>x.id===e.custId)||{name:'NLE'};if(!lines.length){alert('No items');return}let csv='Estimate No,Customer,Date,Memo,Item,Description,Qty,Rate,Amount\n';lines.forEach(l=>{csv+='"'+(e.qb||e.id)+'","'+c.name+'","'+(e.due||'')+'","'+e.name+' - '+(e.loc||'')+'","'+l.name+'","'+(l.desc||'')+'",'+l.qty+','+l.rate+','+l.amt+'\n'});dl(csv,'Estimate_'+e.name.replace(/[^a-z0-9]/gi,'_')+'.csv');toast('Exported!')}
function exportAll(){let csv='Estimate,Customer,Status,Location,Due,Amount\n';estimates.forEach(e=>{const c=customers.find(x=>x.id===e.custId)||{name:''};csv+='"'+e.name+'","'+c.name+'","'+e.status+'","'+(e.loc||'')+'","'+(e.due||'')+'",'+e.total+'\n'});dl(csv,'All_Estimates.csv');toast('Exported!')}
function dl(c,f){const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(c);a.download=f;a.click()}

function fmt(n){return '$'+(n||0).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0})}
function fmtD(d){return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}
function toast(m){document.getElementById('toastMsg').textContent=m;document.getElementById('toast').classList.add('active');setTimeout(()=>document.getElementById('toast').classList.remove('active'),3000)}
</script>
</body>
</html>
